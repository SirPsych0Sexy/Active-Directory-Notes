
Nota: es recomendado aprender que es un active directory y saber al menos lo básico de la terminal de windows antes de intentar hacer algo como esto.

En este modulo no se tratarán la creación de herramientas solo se trabajarán con herramientas de terceros. 

### Instalación de herramientas

Primero que nada necesitaremos varias herramientas para abarcar el proceso de enumeración, comenzamos instalando impacket la cual se encuentra en github:

https://github.com/SecureAuthCorp/impacket.git 

Posteriormente instalamos neo4j y bloodhound, ambas encontradas en los respositorios apt

`sudo apt-get install neo4j bloodhound`

Y de igual forma instalaremos crackmapexec

`sudo apt-get install crackmapexec`

### Enumeración 

Ahora para comenzar con el proceso de enumeración lo haremos con nmap o con un script que inventaré dentro de poco(agregaré el git cuando lo haga), esto servirá para enumerar los puertos y servicios corriendo dentro de dicha maquina. 

`sudo nmap -sS -Pn --min-rate 4000 -p- 10.10.10.10`

Dicho comando requiere permisos root para ejecutarse debido a la creación de paquetes Syn(nota revisar los apuntes de redes) con el parámetro  -sS, mientras que el parámetro -Pn es para especificar que al momento de hacer el escaneo no le haga ping a la maquina y por ultimo el parametro -p- es para escanear todos los puertos.
![[Pasted image 20240228104035.png]]
Si quieres puedes utilizar el parámetro `-open` el cual especifica los puertos abiertos solamente.

Ya que tenemos esto utilizaremos otra herramienta llamada enum4linux la cual se encuentra preinstalada en algunas distros orientadas al pentest o en caso de que no esta en los paquetes del sistema:


Utilizando el comando: `enum4linux -a 10.10.10.10` hacemos una enumeración basica de los servicios dentro de esta maquina, veras que al momento de ejecutar este comando este irá brindando información la cual es muy útil es recomendable que leas todo.

#### enumeración de kerberos 
Si te fijas en la imagen del escaneo de nmap verás como hay un servicio llamado kerberos  corriendo en el puerto 88 este es un protocolo utilizado para autenticación y comprobar la identidad de los usuarios y del host .

escaneamos ese puerto con nmap para comprobar que no fue un falso positivo
![[Pasted image 20240228105836.png]]
Y efectivamente esta activo, ahora pasemos a enumerar usuarios y contraseñas, esto se hará con una herramienta llamada kerbrute primero que nada necesitaremos descargarla desde github con este enlace https://github.com/ropnop/kerbrute/releases y posteriormente pasaremos a enumerar usuarios primero, usamos la instrucción: 
```
kerbrute -d dominio --dc 10.10.10.10 userenum userlist.txt
```
Y nos quedaría un resultado como este:
![[Pasted image 20240228113121.png]]

Una vez terminada la enumeración nosotros intentaremos abusar de una característica de kerberos la cual nos permite iniciar sesión con un usuario sin autenticación este vector de ataque es conocido como ASREPRoasting se produce cuando una cuenta de usuario tiene el privilegio de que no requiere autenticación previa configurada. Esto significa que la cuenta no necesita proporcionar identificación válida antes de solicitar un boleto Kerberos en la cuenta especificada del usuario.

Para esto utilizaremos una característica del comando impacket el cual previamente instalamos esta característica lleva por nombre GetNPUsers utilizamos la siguiente orden: 

```
impacket-GetNPUsers dominio.local/ -no-pass -usersfile lista_de_usuarios.txt
```

Y encontramos algo como esto: ![[Pasted image 20240228113804.png]]
Como vemos se nos da un nombre de la lista y un hash al cual posteriormente le haremos un ataque de fuerza bruta pero primero debemos encontrar que tipo de hash es este

#### Encontrando el hash
(Si sabes que tipo de has es sáltate esto y ya).

Como vemos este hash lleva en la parte delantera la siguiente lineal `$krb5asrep$23$`
esta será para identificar a los hashes de este tipo, ¿y por que no intentar descifrarlo a mano o con Google te preguntarás? pese a que hay herramientas en Google o directamente puede aparecer filtrado pues es fácil los hashesh como tal no se pueden descifrar ya que estos son operaciones matemáticas unilaterales e increíblemente grandes si lo intentaras hacer a manos tardarías meses solamente encontrando una parte del mismo. 

Entonces utilizamos la pagina de hash examples de hashcat y buscamos la primera parte de este mismo, e aquí la pagina https://hashcat.net/wiki/doku.php?id=example_hashes

Y aquí lo tenemos: ![[Pasted image 20240228114721.png]]
Es un hash kerberos 5. 

Igualmente cuando hacemos un ataque con john este se encarga de identificar el tipo de hash al momento de iniciar el ataque
![[Pasted image 20240228115126.png]]
### Volviendo a la enumeración 
Ahora que tenemos el hash identificado y sabemos el tipo podemos utilizar la herramienta que queramos para crackear este, en mi caso utilizare john por cuestiones de recursos aunque si tienes una GPU decente puedes utilizar hashcat por eso no incluiré imágenes o comandos en este apartado.

#### Enumeración del smb 

En este apartado utilizaremos una herramienta integrada en todos los sistemas linux la cual sirve para hacer conexiones a un cliente en smb llamada smbclient

Primero algo rápido: smb es un protocolo el cual permite compartir archivos entre diferentes ordenadores NT en un nodo de red, mientras que por su parte samba es una implementación de este protocolo para los sistemas basados en unix. 

Intentamos listar con el comando smbclient -L para listar y -U para autenticarnos.

`smbclient -L 10.10.10.10 -U dominio.local/usuario%contraseña`
![[Pasted image 20240305181804.png]]

Ahora pasamos a enumera con smbmap para ver que tipo de permisos tenemos sobre estos servicios compartidos.
![[Pasted image 20240305182145.png]]
Como podemos ver tenemos permisos de lectura en 4 servicios compartidos pero el que verdaderamente me interesa es el de backup, ¿entonces como podemos acceder a uno de estos recursos?.

Pues utilizando otra vez smbclient esta vez de la siguiente forma: `smbclient \\\\10.10.10.10\\recurso -U usuario%contraseña` y este nos brindará una shell como la de la imagen de abajo. 
![[Pasted image 20240305182909.png]]

Y para descargar estos archivos en nuestro ordenador utilizamos el comando get, acompañado del nombre del archivo. 
`get archivo.txt`

Y podemos utilizar crackmapexec con el siguiente comando `cme smb 10.10.10.10/24` para detectar equipos de esa red. 

En caso de contar con un usuario el cual tenga ciertos privilegios dentro de la red podemos autenticarnos con los parámetros `-u usuario -p contraseña` 


### Explotación 

En esta etapa ya tenemos información y usuarios con los que podamos entrar al dominio, esto significa que ya es momento de conectarnos, en este caso utilizaré el usuario backup cuyas credenciales encontré dentro de un archivo dentro de la carpeta backup, asumiremos que este usuario tiene todos los permisos sobre el dominio(que por lo general los usuarios backup y Administrador los tienen) por lo que intentaremos sacar los hashes de otros usuarios dentro de este dominio. 

Para ello probaremos con una herramienta de mucha utilidad llamada secretsdump.py, con ella ejecutamos la siguiente instrucción: `python3 secretsdump.py -dc-ip dominio.local usuario:contraseña@dominio.local`

Y obtenemos hashes de usuarios dentro del dominio
![[Pasted image 20240305185649.png]]

Y ahora nos conectamos a estos usuarios con una herramienta llamada `Evil-WinRM` esta tiene una opción la cual nos permite autenticarnos con el hash del usuario al que queremos acceder, este método es llamado pass the hash y se basa en que nos permite autenticarnos con el hash del usuario sin necesidad de utilizar una contraseña para este mismo.  

Utilizamos el comando `evil-winrm -i dominio.local -u Usuario -H hash` y...
![[Pasted image 20240305191001.png]]
Tenemos acceso a una terminal dentro de la maquina de este usuario ya desde aquí buscas lo que necesites en ella. 

Obviamente no en todas las ocasiones nos encontraremos con un dominio tan fácil de vulnerar  pero esto es para que te hagas una idea de esta travesía y de la metodología que se utiliza. 


#### Capturando algunos hashes 

##### Samba Relay IPv4
Una vez dentro del dominio algo que podemos hacer es utilizar el responder.py para envenenar la conexión e interceptar los hashes.

`python3 Responder.py -I eth0 -rdw`

Esto sucede debido a que el samba no esta firmado y al momento de intentar acceder a un recuso compartido dentro de la red el responder intercepta esa comunicación como si fuera el recurso que se esta buscando dentro de la red, al hacer esto el equipo se autentica al nivel de la red esta autenticación es representada como un hash NTLMv2 estos hashes no sirven para hacer un pass the hash pero si se pueden crackear de la misma forma que el hash de kerberos.


##### descargo y notas

Todo lo que se utilizo aquí fue testeado en dos maquinas de tryhackme y en un entorno real esto puede variar ya que hay que tener en cuenta cosas como el firewall y sus reglas o el propio antivirus que puede bloquear nuestras acciones, esto solo son notas muy básicas las cuales aún no están completas y serán actualizadas conforme se valla aprendiendo y enriqueciendo  este mismo contenido.

Si has llegado aquí gracias por leerlo y escríbeme: flag{lei_esta_cosa} 



### Uso de la suite impacket

Como se ha mostrador anteriormente impacket es una suite muy buena en lo que a pentesting a active directory se trata, en este apartado quisiera tratar un poco mas a detalles otros aspectos y uso de la suite. 